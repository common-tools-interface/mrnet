#/****************************************************************************
# * Copyright © 2003-2010 Dorian C. Arnold, Philip C. Roth, Barton P. Miller *
# *                  Detailed MRNet usage rights in "LICENSE" file.          *
# ****************************************************************************/
# $Id: Makefile.in,v 1.14 2008/10/09 19:50:12 mjbrim Exp $

@SET_MAKE@

prefix  = @prefix@
exec_prefix=@exec_prefix@
srcdir  = @abs_srcdir@
libdir  = @libdir@
includedir  = @includedir@

MRNET_OS = @MRNET_OS@

VPATH   = @abs_srcdir@/src

TARGET    = libmrnet_lightweight.a
TARGET_SO = libmrnet_lightweight.so

TARGETS = $(TARGET)
ifeq ($(BUILD_SHARED_LIBS), yes)
    TARGETS += $(TARGET_SO)
endif 

SRCS    = BackEndNode.c \
          ChildNode.c \
          DataElement.c \
          Error.c \
          Filter.c \
	  FilterDefinitions.c \
          map.c \
          Message.c \
          Network.c \
          NetworkTopology.c \
          Packet.c \
          PeerNode.c \
          PerfDataEvent.c \
          SerialGraph.c \
          Stream.c \
          utils_lightweight.c \
          vector.c \
          $(srcdir)/../src/byte_order.c \
          $(srcdir)/../src/pdr.c \
          $(srcdir)/../src/pdr_mem.c \
          $(srcdir)/../src/pdr_sizeof.c

ifeq ($(MRNET_OS), linux)
    SRCS += PerfDataSysEvent_linux.c
else
    SRCS += PerfDataSysEvent_none.c
endif

OBJS = $(subst $(srcdir)/../src/, , $(SRCS:.c=.o))
DEPS = $(subst $(srcdir)/../src/, , $(SRCS:.c=.d))

all: $(TARGETS)

sharedobj: $(TARGET_SO)

$(TARGET): $(OBJS)
	@echo Archiving `basename $@` ...
	$(AR) $(ARFLAGS) $@ $^
	$(RANLIB) $@

$(TARGET_SO): $(OBJS)
	@echo Building `basename $@` ...
	$(CC) $(SOFLAGS) -o $@ $^

install: $(TARGETS)
	for dir in $(libdir) $(includedir) $(includedir)/mrnet_lightweight ; do \
	    if [ ! -d $$dir ] ; then \
	        $(MKDIR_P) $$dir ; \
	        chmod 755 $$dir ; \
	    fi \
	done
	if [ ! -x `echo $(INSTALL) | sed 's/ .*$$//'` ] ; then \
	    chmod +x `echo $(INSTALL) | sed 's/ .*$$//'` ; \
	fi
	$(INSTALL) -m 755 $(TARGET) $(libdir)/
	if [ -f $(TARGET_SO) ] ; then \
            $(INSTALL) -m 755 $(TARGET_SO) $(libdir)/ ; \
        fi
	for hdr in $(srcdir)/include/mrnet_lightweight/*.h ; do \
	    if [ -f $$hdr ] ; then \
	        $(INSTALL) -m 644 $$hdr $(includedir)/mrnet_lightweight/ ; \
	    fi \
	done

clean:
	for file in $(OBJS) $(TARGETS) ; do \
	    if [ -f $$file ] ; then $(RM) $$file ; fi \
	done

distclean: clean
	for file in $(DEPS) config.status config.log config.h Makefile ; do \
	    if [ -f $$file ] ; then $(RM) $$file ; fi \
	done
	for file in `find $(srcdir) -name "*~" -print` ; do $(RM) $$file ; done

# pattern rules
@VERBOSEMAKE@
.SUFFIXES:
.SUFFIXES: .c .o .d

# add phony target to force serial build of lightweight backend.
# this would not be needed if archive was built differently
# -- and then we could build in parallel
.NOTPARALLEL:

%.d: %.c
	@echo Building depends file `basename $@` ...
	$(MAKEDEPENDS)  $< $*.o $@ $(INCDIR_LIGHTWEIGHT)

%.o: %.c
	@echo Compiling `basename $@` ...
	$(CC) $(CCFLAGS) -o $@ -c $<

%.d: $(srcdir)/../src/%.c
	@echo Building depends file `basename $@` ...
	$(MAKEDEPENDS)  $< $*.o $@ $(INCDIR_LIGHTWEIGHT)

%.o: $(srcdir)/../src/%.c
	@echo Compiling `basename $@` ...
	$(CC) $(CCFLAGS) -o $@ -c $<

# make sure file dependencies are determiend and used
-include $(DEPS)

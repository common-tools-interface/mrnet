#This script does not configure, compile, or install the LaunchMON libraries.

prefix      = @prefix@
exec_prefix = @exec_prefix@
ILIBDIR     = @libdir@
IINCDIR     = @includedir@

@SET_MAKE@

AR      = @AR@
ARFLAGS = @ARFLAGS@
RANLIB  = @RANLIB@
RM      = @RM@
INSTALL = @INSTALL@
MKDIR_P = mkdir -p
LAUNCH_TYPE = @MRNET_STARTUP_METHOD@

PLATDIR = @PLATFORM_BUILD@
BINDIR  = $(PLATDIR)/bin
LIBDIR  = $(PLATDIR)/lib
OBJDIR  = $(PLATDIR)/obj/libi
DEPDIR  = $(PLATDIR)/depends/libi


ROOTDIR     = @MRNET_ROOT@
BASEDIR     = @abs_srcdir@
LIBI_ROOT   = $(ROOTDIR)/libi
SRC_DIR     = $(LIBI_ROOT)/src
XPLATDIR    = $(ROOTDIR)/xplat
LIBXPLAT    = $(BINDIR)/libxplat.a
LIBXPLAT_SO = $(LIBDIR)/libxplat.so
LMON_DIR    = @LMON_IDIR@
LMON_LIBS   = -L$(LMON_DIR)/lib -lmonfeapi -lmonmwapi -lmonbeapi
MAKEDEPENDS = $(ROOTDIR)/conf/makedepends.sh
INCDIR      = $(LIBI_ROOT)/include
INCLUDES    = -I$(INCDIR) -I$(XPLATDIR)/include
TEST_LIBS   = $(LIBDIR)/liblibi.a $(LIBXPLAT)
SEQ_LIBS    = $(LIBXPLAT) -lpthread

libi_incdir    = $(INCDIR)/libi
install_libi_incdir = $(IINCDIR)/libi
	
LIBI_SRCS = libi_api.cxx \
            debug.cxx
TEST_SRCS = testmain.cxx \
            testmember.cxx

ifeq ($(LAUNCH_TYPE), slurm)
    INCLUDES  += -I$(LMON_DIR)/include
    TEST_LIBS += $(LMON_LIBS)
    LIBI_SRCS += ProcessGroup_LMONMW.C \
		    ProcessGroupMember_LMONMW.C
else
    LIBI_SRCS += ProcessGroup_MULTIRSH.C \
		    ProcessGroupMember_MULTIRSH.C
endif

LIBI_OBJS = $(addprefix $(OBJDIR)/, $(patsubst %.cxx,%.o,$(patsubst %.C,%.o,$(patsubst %.c,%.o,$(notdir $(LIBI_SRCS))))))
TEST_OBJS = $(addprefix $(OBJDIR)/, $(patsubst %.cxx,%.o,$(patsubst %.C,%.o,$(patsubst %.c,%.o,$(notdir $(TEST_SRCS))))))

LIBLIBI_HEADERS = $(wildcard $(libi_incdir)/*.h)
INSTALL_LIBI_HEADERS = $(addprefix $(install_libi_incdir)/, $(notdir $(LIBLIBI_HEADERS)))

COMPILER_TYPE = @COMPILER_TYPE@
CXX           = @CXX@
CXXFLAGS      = @CXXFLAGS@ $(INCLUDES)
SOFLAGS       = @SOFLAGS@

all: liblibi

test: testmain testmember

clean:
	rm $(OBJDIR)/*.o; rm $(DEPDIR)/*.d; rm $(LIBDIR)/liblibi.a; rm $(LIBDIR)/liblibi.so;

install-prep:
	@echo Creating install directories
	for dir in $(IBINDIR) $(ILIBDIR) $(install_libi_incdir) ; do \
	    if [ ! -d $$dir ] ; then \
	        $(MKDIR_P) $$dir ; \
	        chmod 755 $$dir ; \
	    fi \
	done
	if [ ! -x `echo $(INSTALL) | sed 's/ .*$$//'` ] ; then \
	    chmod +x `echo $(INSTALL) | sed 's/ .*$$//'` ; \
	fi
	
$(INSTALL_LIBI_HEADERS): $(install_libi_incdir)/%: $(libi_incdir)/%
	@echo Installing LIBI header $(<F)
	$(INSTALL) -m 644 $< $(@D)

install: liblibi install-prep $(INSTALL_LIBI_HEADERS)
	@echo Installing LIBI libraries
	$(INSTALL) -m 755 $(LIBLIBI) $(ILIBDIR)/
	$(INSTALL) -m 755 $(LIBLIBI_SO) $(ILIBDIR)/

liblibi: $(LIBI_OBJS)
	$(AR) $(ARFLAGS) $(LIBDIR)/liblibi.a $(LIBI_OBJS)
	$(CXX) $(SOFLAGS) -o $(LIBDIR)/liblibi.so $(LIBI_OBJS)
	

testmain: liblibi $(OBJDIR)/testmain.o
	$(CXX) $(CXXFLAGS) $(OBJDIR)/testmain.o -o testmain $(TEST_LIBS)

testmember: liblibi $(OBJDIR)/testmember.o
	$(CXX) $(CXXFLAGS) $(OBJDIR)/testmember.o -o testmember $(TEST_LIBS)

$(OBJDIR)/%.o: $(SRC_DIR)/%.c $(DEPDIR)/%.d
	@echo Compiling `basename $@` ...
	$(CXX) $(CXXFLAGS) $(C_AS_CPLUSPLUS) -o $@ -c $<

$(OBJDIR)/%.o: $(SRC_DIR)/%.C $(DEPDIR)/%.d
	@echo Compiling `basename $@` ...
	$(CXX) $(CXXFLAGS) -o $@ -c $<

$(OBJDIR)/%.o: $(SRC_DIR)/%.cxx $(DEPDIR)/%.d
	@echo Compiling `basename $@` ...
	$(CXX) $(CXXFLAGS) -o $@ -c $<

$(DEPDIR)/%.d: $(SRC_DIR)/%.c
	@echo Building Depends File `basename $@` ...
	$(MAKEDEPENDS)  $< $(OBJDIR)/$*.o $@ $(INCLUDES)

$(DEPDIR)/%.d: $(SRC_DIR)/%.C
	@echo Building Depends File `basename $@` ...
	$(MAKEDEPENDS)  $< $(OBJDIR)/$*.o $@ $(INCLUDES)

$(DEPDIR)/%.d: $(SRC_DIR)/%.cxx
	@echo Building Depends File `basename $@` ...
	$(MAKEDEPENDS)  $< $(OBJDIR)/$*.o $@ $(INCLUDES)
	